# IA_finance - Day Trading Strategy Engine

This project is a complete, end-to-end framework for discovering, optimizing, and executing day trading strategies for financial assets like PETR4, WIN (Mini-√çndice), and WDO (Mini-D√≥lar).

The system is built on a two-stage architecture:
1.  **Offline Research Engine**: Uses a sophisticated genetic algorithm and walk-forward validation to find robust trading strategies from historical data.
2.  **Live Trading Bot & Dashboard**: Connects to MetaTrader 5, applies the learned strategies to live market data, and provides a user interface for signal visualization and trade execution.

---

## üèõÔ∏è Project Architecture

The workflow is designed to separate heavy-duty research from lightweight live execution.

### Stage 1: Offline Research & Model Training (`backend/backtest_ia_5min.py`)

This is the core of the system. It takes historical market data (in `.csv` format) and performs the following steps for each asset:

1.  **Genetic Evolution**: A genetic algorithm evolves a population of trading strategies across multiple "families" (e.g., `macross`, `pullback`, `rsi_reversal`). Each strategy is evaluated using a robust walk-forward methodology to avoid overfitting.
2.  **Hall of Fame Creation**: The best-performing, most robust strategies discovered during evolution are saved to a `{symbol}_hall_of_fame.json` file.
3.  **Ensemble Building**: The "Hall of Fame" strategies are combined into a weighted ensemble to create a single, more reliable signal. The Stop Loss (SL) and Take Profit (TP) levels for this ensemble are also optimized.
4.  **ML Model Training**: A LightGBM classifier is trained to act as a final filter. It uses market features *and* the ensemble's signal as inputs to predict the probability of the price moving up.
5.  **Artifact Generation**: The process generates several key artifacts in the `C:\Users\Marco\ia_finance` directory:
    -   `modelos/{symbol}_lgbm_model.joblib`: The final trained LightGBM model.
    -   `modelos/{symbol}_features.json`: The exact list of features the model was trained on.
    -   `{symbol}_hall_of_fame.json`: The list of the best individual strategies.
    -   `pipeline_results.json`: A summary of the performance metrics for the ensemble and the final ML-filtered strategy.
    -   `{symbol}_final_equity.png`: A plot of the final backtested equity curve.

### Stage 2: Live Execution & UI (`backend/sinais.py` & `ia_5min_mt5.py`)

This stage uses the artifacts generated by the research engine to trade in the live market.

1.  **Live Bot (`sinais.py`)**:
    -   Connects to a running MetaTrader 5 terminal.
    -   Fetches the latest candle data for an asset.
    -   Loads the corresponding Hall of Fame strategies, ML model, feature list, and optimized parameters.
    -   **Replicates the entire backtest logic on the live data**: It generates the ensemble signal, prepares the feature set, and uses the ML model to filter the signal.
    -   Returns a final "COMPRA" (BUY), "VENDA" (SELL), or `None` signal along with its confidence and optimized SL/TP parameters.

2.  **Streamlit Dashboard (`ia_5min_mt5.py`)**:
    -   Provides a web-based user interface.
    -   Calls the `sinais.py` bot periodically for each asset.
    -   Displays the final signal, price, confidence, and dynamic SL/TP values.
    -   Includes an "EXECUTE" button that sends the trade to MetaTrader 5 using the precise, optimized parameters calculated by the backend.

---

## üöÄ How to Use

### 1. Prerequisites

- Python 3.x
- A running MetaTrader 5 terminal.
- Required Python packages (e.g., `pandas`, `scikit-learn`, `lightgbm`, `joblib`, `streamlit`, `MetaTrader5`, etc.). Install them via:
  ```bash
  pip install pandas numpy matplotlib joblib scikit-learn lightgbm streamlit streamlit-autorefresh MetaTrader5 filelock feedparser
  ```

### 2. Data Preparation

- Place your historical M5 data as `.csv` files inside the `C:\Users\Marco\Documents\dados` folder.
- Ensure the filenames match the patterns defined in `backtest_ia_5min.py` (e.g., `PETR4.csv`, `WIN$.csv`).

### 3. Workflow

**Step 1: Run the Research Engine (Weekly/Monthly)**

Open a terminal and run the main backtesting script. This will perform the genetic optimization and train the models. This process is computationally intensive and can take a long time.

```bash
cd c:\Users\Marco\ia_finance\backend
python backtest_ia_5min.py
```

After it finishes, the `C:\Users\Marco\ia_finance` and `C:\Users\Marco\ia_finance\modelos` folders will be populated with the latest models and strategies.

**Step 2: Launch the Live Trading Dashboard**

Once the models are trained, you can start the Streamlit dashboard to monitor live signals.

```bash
cd c:\Users\Marco\ia_finance
streamlit run ia_5min_mt5.py
```

This will open a new tab in your web browser showing the dashboard. The dashboard will automatically connect to MT5, generate signals using the backend logic, and allow you to execute trades.

---

## üìÅ File Descriptions

- `ia_5min_mt5.py`: The Streamlit dashboard (UI). This is the file you run for live trading.
- `backend/backtest_ia_5min.py`: The main research and optimization engine. Run this to find strategies and train models.
- `backend/sinais.py`: The live trading bot logic. It's called by the Streamlit dashboard and contains the logic to generate signals from the trained artifacts.
- `modelos/`: This folder stores the trained ML models (`.joblib`) and their feature lists (`.json`). **This is a critical output folder.**
- `*_hall_of_fame.json`: Stores the best-performing strategies found by the genetic algorithm for each symbol.
- `pipeline_results.json`: A JSON summary of the backtest performance for all assets.
- `train_models_from_csv.py`: **(Legacy)** An older, simpler script for training a RandomForest model. It has been superseded by the more advanced logic in `backtest_ia_5min.py` and can be ignored or deleted.
